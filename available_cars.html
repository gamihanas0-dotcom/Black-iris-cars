<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Available Cars | Black Iris Cars</title>

    <meta name="description" content="View our full fleet of available rental cars. From economy hatchbacks to luxury SUVs, find the perfect car for your trip in Morocco.">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="data.js"></script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2Y2MG9ZZ46"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-2Y2MG9ZZ46');
    </script>
    
    <style>
        /* Custom Font Poppins */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f7f9; 
            transition: all 0.3s ease; /* For smooth RTL transition */
        }
        /* Monochrome Theme Colors + Royal Blue Accent */
        .primary-dark { background-color: #1a1a1a; } 
        .text-primary-dark { color: #1a1a1a; } 
        .accent-blue { background-color: #4169e1; } /* Royal Blue */
        .hover\:accent-blue-dark:hover { background-color: #2b4daa; } /* Darker Royal Blue */
        .text-accent-blue { color: #4169e1; }

        /* Style for filter sidebar on mobile */
        #filter-sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%); 
        }
        #filter-sidebar.open {
            transform: translateX(0);
        }

        /* RTL adjustment for sidebar sliding direction */
        [dir="rtl"] #filter-sidebar {
            transform: translateX(100%); 
            left: auto; 
            right: 0; 
        }

        [dir="rtl"] #filter-sidebar.open {
            transform: translateX(0);
        }
        
        input[type="checkbox"]:checked {
            background-color: #1a1a1a;
            border-color: #1a1a1a;
        }

        #contact-modal {
            transition: opacity 0.3s ease-in-out;
        }

        [dir="rtl"] .ltr\:mr-2 { margin-right: 0; margin-left: 0.5rem; }
        [dir="rtl"] .ltr\:text-left { text-align: right; }
        [dir="rtl"] .ltr\:justify-start { justify-content: flex-end; }
        [dir="rtl"] .md\:ltr\:space-x-8 > * + * { margin-left: 0; margin-right: 2rem; }
        
        /* === NEW: Compact Select Styling === */
        .compact-select {
            font-size: 0.875rem; /* 14px */
            font-weight: 600; /* font-semibold */
            color: #1a1a1a; /* text-primary-dark */
            background-color: transparent;
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 8px 12px;
            margin: 0;
            cursor: pointer;
            
            /* Adds a subtle custom arrow */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M6 9l4 4 4-4'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.2em 1.2em;

            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            
            padding-right: 2.5rem; /* Make space for the new arrow */
        }
        
        /* Make the desktop ones borderless and cleaner */
        .hidden.md\:flex .compact-select {
             border: none;
             font-weight: 600; /* font-semibold */
             font-size: 0.875rem; /* 14px */
             padding: 4px 1.4rem 4px 0;
             background-position: right 0.1rem center;
        }

        [dir="rtl"] .hidden.md\:flex .compact-select {
            background-position: left 0.1rem center;
            padding-left: 1.4rem;
            padding-right: 0;
        }
        
        [dir="rtl"] .compact-select {
            background-position: left 0.5rem center;
            padding-left: 2.5rem;
            padding-right: 12px;
        }

        /* Target the text inside the option (for black text) */
        .compact-select option {
            color: #000000;
            font-weight: 400;
        }
    </style>
</head>
<body class="antialiased" dir="ltr">

    <header class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="index.html" class="flex items-center">
                    <img src="https://i.postimg.cc/B6LWwXNL/923d79fe-5117-4849-9761-57e1fe5a8d96.jpg" alt="Black Iris Cars Logo" class="w-10 h-10 mr-2 rounded-full border border-gray-100">
                    <span class="text-2xl font-extrabold text-primary-dark">BLACK IRIS cars</span>
                </a>

                <div class="flex items-center space-x-3 sm:space-x-4">
                    
                    <div class="hidden md:flex items-center space-x-3 border-r border-gray-200 pr-3 sm:pr-4">
                        <select id="currency-selector" class="compact-select">
                            <option value="DH">DH</option>
                            <option value="EUR">EUR</option>
                            <option value="USD">USD</option>
                        </select>
                        <select id="language-selector" class="compact-select">
                            <option value="en">EN</option>
                            <option value="fr">FR</option>
                            <option value="ar">AR</option>
                        </select>
                    </div>

                    <nav class="hidden md:flex space-x-8">
                        <a href="index.html#featured" class="text-gray-600 hover:text-accent-blue transition duration-150" data-i18n="nav-fleet">Our Fleet</a>
                        <a href="index.html#why-us" class="text-gray-600 hover:text-accent-blue transition duration-150" data-i18n="nav-why">Why Choose Us</a>
                        <a href="index.html#contact" class="text-gray-600 hover:text-accent-blue transition duration-150" data-i18n="nav-contact">Contact</a>
                    </nav>

                    <button id="filter-menu-button" class="md:hidden text-gray-600 hover:text-accent-blue p-2 rounded-lg transition duration-150">
                        <i data-lucide="filter" class="w-6 h-6"></i>
                    </button>
                    
                    <button id="mobile-menu-button" class="md:hidden text-gray-600 hover:text-accent-blue p-2 rounded-lg transition duration-150">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="mobile-menu" class="md:hidden bg-white border-t border-gray-100 opacity-0 -translate-y-2 transform transition-all duration-300 ease-out fixed top-16 left-0 right-0 z-40" style="pointer-events: none;">
            <div class="px-4 pt-4 pb-3 space-y-4">
                <div class="flex items-center space-x-4">
                    <select id="currency-selector-mobile" class="compact-select w-full">
                        <option value="DH">DH</option>
                        <option value="EUR">EUR</option>
                        <option value="USD">USD</option>
                    </select>
                    <select id="language-selector-mobile" class="compact-select w-full">
                        <option value="en">English</option>
                        <option value="fr">Français</option>
                        <option value="ar">العربية</option>
                    </select>
                </div>
                
                <div class="space-y-1">
                    <a href="index.html#featured" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-accent-blue" data-i18n="nav-fleet">Our Fleet</a>
                    <a href="index.html#why-us" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-accent-blue" data-i18n="nav-why">Why Choose Us</a>
                    <a href="index.html#contact" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50 hover:text-accent-blue" data-i18n="nav-contact">Contact</a>
                </div>
            </div>
        </div>
    </header>
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-primary-dark mb-4" data-i18n="h1-available">
            Available Rental Cars
        </h1>
        
        <div id="filter-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

        <div class="md:grid md:grid-cols-4 lg:grid-cols-5 md:gap-8">

            <div id="filter-sidebar" class="fixed top-0 left-0 h-full w-3/4 max-w-xs md:max-w-none bg-white p-6 shadow-2xl z-40 md:relative md:col-span-1 lg:col-span-1 md:h-auto md:p-0 md:shadow-none md:bg-transparent md:transform-none">
                
                <button id="filter-close-button" class="md:hidden absolute top-4 right-4 text-gray-800 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                
                <h3 class="text-2xl font-bold text-primary-dark mb-6 border-b pb-3" data-i18n="h3-filter">Filter Options</h3>
                
                <form id="filter-form" class="space-y-6">
                    <div>
                        <label for="price-range" class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="label-price">Price Range (DH/day)</label>
                        <input type="range" id="price-range" min="200" max="1500" value="1500" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer text-primary-dark">
                        <span id="price-value" class="text-sm text-gray-600 mt-1 block">Up to 1500 DH</span>
                    </div>

                    <div>
                        <p class="text-sm font-semibold text-gray-700 mb-2">Transmission</p>
                        <div class="space-y-2" id="transmission-filters">
                            <label class="flex items-center text-gray-600 ltr:justify-start">
                                <input type="checkbox" name="transmission" value="automatic" class="rounded text-primary-dark focus:ring-primary-dark ltr:mr-2"> <span data-i18n="automatic">Automatic</span>
                            </label>
                            <label class="flex items-center text-gray-600 ltr:justify-start">
                                <input type="checkbox" name="transmission" value="manual" class="rounded text-primary-dark focus:ring-primary-dark ltr:mr-2"> <span data-i18n="manual">Manual</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <p class="text-sm font-semibold text-gray-700 mb-2">Vehicle Type</p>
                        <div class="space-y-2" id="type-filters">
                            <label class="flex items-center text-gray-600 ltr:justify-start">
                                <input type="checkbox" name="car-type" value="sedan" class="rounded text-primary-dark focus:ring-primary-dark ltr:mr-2"> Sedan
                            </label>
                            <label class="flex items-center text-gray-600 ltr:justify-start">
                                <input type="checkbox" name="car-type" value="hatchback" class="rounded text-primary-dark focus:ring-primary-dark ltr:mr-2"> Hatchback
                            </label>
                            <label class="flex items-center text-gray-600 ltr:justify-start">
                                <input type="checkbox" name="car-type" value="suv" class="rounded text-primary-dark focus:ring-primary-dark ltr:mr-2"> SUV / Crossover
                            </label>
                            <label class="flex items-center text-gray-600 ltr:justify-start">
                                <input type="checkbox" name="car-type" value="luxury-suv" class="rounded text-primary-dark focus:ring-primary-dark ltr:mr-2"> Luxury SUV
                            </label>
                        </div>
                    </div>

                    <button type="button" id="apply-filters-btn" class="w-full accent-blue text-white font-semibold py-2 rounded-lg hover:accent-blue-dark transition duration-300 shadow-md mt-4">
                        Apply Filters
                    </button>
                </form>
            </div>

            <div class="md:col-span-3 lg:col-span-4 space-y-6" id="results-container">
                
                <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-gray-100">
                    <p class="text-sm text-gray-600" id="car-count">Loading cars...</p> 
                </div>

                </div>

        </div>
    </main>

    <div id="contact-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md m-4 transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-primary-dark" data-i18n="h3-modal">Book Your Car</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-primary-dark">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <p class="text-gray-700 mb-6" data-i18n="modal-p">Please choose your preferred contact method. Your chosen car details will be pre-filled.</p>

            <div class="space-y-4">
                <a id="whatsapp-link" href="#" target="_blank" class="w-full flex items-center justify-center bg-green-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-green-700 transition duration-300 shadow-md">
                    <i data-lucide="message-circle" class="w-5 h-5 ltr:mr-3"></i> <span data-i18n="btn-whatsapp">WhatsApp</span>
                </a>
                <a id="email-link" href="#" class="w-full flex items-center justify-center accent-blue text-white font-semibold py-3 px-6 rounded-lg hover:accent-blue-dark transition duration-300 shadow-md">
                    <i data-lucide="mail" class="w-5 h-5 ltr:mr-3"></i> <span data-i18n="btn-email">Email</span>
                </a>
            </div>
            <p class="text-xs text-gray-500 mt-6 text-center" data-i18n="modal-footer">We will confirm availability and finalize the booking details.</p>
        </div>
    </div>


    <footer class="primary-dark text-white py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 border-b border-gray-700 pb-8 mb-8">
                <div>
                    <h3 class="text-2xl font-extrabold mb-4 text-gray-300">BLACK IRIS cars</h3>
                    <p class="text-gray-400 text-sm">Your reliable partner for car rentals across Morocco.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4" data-i18n="h4-nav">Quick Navigation</h4>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><a href="index.html#featured" class="hover:text-accent-blue transition duration-150" data-i18n="nav-fleet">Our Fleet</a></li>
                        <li><a href="index.html#why-us" class="hover:text-accent-blue transition duration-150" data-i18n="nav-why">Our Promise</a></li>
                        <li><a href="index.html#contact" class="hover:text-accent-blue transition duration-150" data-i18n="nav-contact">Contact</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4" data-i18n="h4-contact">Contact & Booking</h4>
                    <p class="text-sm text-gray-400 mb-2 flex items-center ltr:justify-start"><i data-lucide="phone" class="w-4 h-4 ltr:mr-2 text-accent-blue"></i> 0602020402</p>
                    <p class="text-sm text-gray-400 mb-2 flex items-center ltr:justify-start"><i data-lucide="mail" class="w-4 h-4 ltr:mr-2 text-accent-blue"></i> <a href="mailto:blackiriscars@gmail.com" class="hover:text-accent-blue">blackiriscars@gmail.com</a></p>
                    <p class="text-sm text-gray-400 mb-2 flex items-center ltr:justify-start"><i data-lucide="map-pin" class="w-4 h-4 ltr:mr-2 text-accent-blue"></i> <span data-i18n="address-text">10 rue ouarzazat hassan rabat</span></p>
                    <a href="httpsm" class="text-sm text-white px-3 py-1 mt-2 inline-flex items-center rounded-lg bg-green-600 hover:bg-green-700 transition duration-150">
                        <i data-lucide="message-circle" class="w-4 h-4 ltr:mr-2"></i> <span data-i18n="whatsapp-text">WhatsApp</span> 0602020402
                    </a>
                </div>
            </div>
            <div class="text-center text-sm text-gray-500 pt-4">
                &copy; <span data-i18n="copy-right">2024 Black Iris Cars. All rights reserved.</span>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- 1. Global State & Element References ---
            let currentLang = 'en';
            let currentCurrency = 'DH'; // NEW
            let rentalLocation = '';
            let rentalPickupDate = '';
            let rentalReturnDate = '';

            const langSelectors = document.querySelectorAll('#language-selector, #language-selector-mobile');
            const currencySelectors = document.querySelectorAll('#currency-selector, #currency-selector-mobile'); // NEW
            const priceRange = document.getElementById('price-range');
            const priceValue = document.getElementById('price-value');
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            const carCountElement = document.getElementById('car-count');
            const transmissionFilters = document.querySelectorAll('#transmission-filters input[type="checkbox"]');
            const typeFilters = document.querySelectorAll('#type-filters input[type="checkbox"]');
            
            const filterButton = document.getElementById('filter-menu-button'); // This is the FILTER button
            const filterSidebar = document.getElementById('filter-sidebar');
            const filterCloseButton = document.getElementById('filter-close-button');
            const filterBackdrop = document.getElementById('filter-backdrop'); 
            const resultsContainer = document.getElementById('results-container');
            
            const modal = document.getElementById('contact-modal');
            const modalContent = document.getElementById('modal-content');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const whatsappLink = document.getElementById('whatsapp-link');
            const emailLink = document.getElementById('email-link');

            // === NEW: Seamless Mobile Menu Elements ===
            const mobileMenuButton = document.getElementById('mobile-menu-button'); // This is the NAV MENU button
            const mobileMenu = document.getElementById('mobile-menu');
            
            // These are populated by renderAllCars()
            let carCards = []; 
            let bookButtons = [];

            // --- 2. Core Functions ---

            function getTranslation(key) {
                const translation = translations[currentLang][key];
                return (typeof translation === 'function') ? translation : (translation || key);
            }
            
            // === NEW: Price Calculation Function ===
            function calculatePrice(basePrice) {
                if (currentCurrency === 'EUR') {
                    return { price: (basePrice / 10).toFixed(0), symbol: '€' };
                }
                if (currentCurrency === 'USD') {
                    return { price: (basePrice / 10).toFixed(0), symbol: '$' };
                }
                return { price: basePrice, symbol: '' }; // For DH
            }

            function getLocalStorageData() {
                rentalLocation = localStorage.getItem('rentalLocation') || '';
                rentalPickupDate = localStorage.getItem('rentalPickupDate') || '';
                rentalReturnDate = localStorage.getItem('rentalReturnDate') || '';
            }
            
            // Syncs desktop and mobile selectors
            function updateAllSelectors(selector, value) {
                document.querySelectorAll(selector).forEach(sel => {
                    sel.value = value;
                });
            }

            function setLanguage(lang) {
                currentLang = lang;
                updateAllSelectors('#language-selector, #language-selector-mobile', lang);
                
                const dictionary = translations[lang];
                
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (dictionary[key] && typeof dictionary[key] === 'string') {
                        element.textContent = dictionary[key];
                    }
                });
                
                if (carCountElement) {
                    updateCarCount(document.querySelectorAll('.car-card:not([style*="display: none"])').length);
                }

                document.body.setAttribute('dir', (lang === 'ar') ? 'rtl' : 'ltr');
                document.title = (getTranslation('h1-available') || 'Available Cars') + (lang === 'ar' ? ' | بلاك آيرس' : ' | Black Iris');

                if (priceRange && priceValue) {
                    const prefix = lang === 'ar' ? 'يصل إلى' : 'Up to';
                    priceValue.textContent = `${prefix} ${priceRange.value} DH`;
                }

                document.querySelectorAll('select option').forEach(option => {
                    const key = option.getAttribute('data-i18n');
                    if (key && dictionary[key] && typeof dictionary[key] === 'string') {
                        option.textContent = dictionary[key];
                    }
                });
                
                lucide.createIcons();
            }

            // === NEW: Set Currency Function ===
            function setCurrency(currency) {
                currentCurrency = currency;
                updateAllSelectors('#currency-selector, #currency-selector-mobile', currency);
                renderAllCars(); // Re-render list with new prices
                filterCars();    // Re-apply filter
            }
            
            /**
             * Dynamically builds all car cards from data.js
             */
            function renderAllCars() {
                if (!resultsContainer) return;

                // Clear all child nodes *except* the first one (the car count bar)
                while (resultsContainer.children.length > 1) {
                    resultsContainer.removeChild(resultsContainer.lastChild);
                }

                // Loop through data.js and build cards
                carData.forEach(car => {
                    const transmissionText = getTranslation(car.transmission.toLowerCase());
                    const seatsKey = car.seats === 6 ? 'car-seats-6' : 'car-seats';
                    const seatsText = getTranslation(seatsKey);
                    const { price, symbol } = calculatePrice(car.price); // NEW: Calculate price
                    const carPriceString = `${symbol}${price}${currentCurrency === 'DH' ? ' DH' : ''}`;

                    const card = document.createElement('div');
                    card.className = "car-card bg-white rounded-xl shadow-lg overflow-hidden flex flex-col md:flex-row border border-gray-200 hover:shadow-xl transition duration-300";
                    card.setAttribute('data-price', car.price); // Filter is always on base DH price
                    card.setAttribute('data-transmission', car.transmission.toLowerCase());
                    card.setAttribute('data-type', car.type.toLowerCase());

                    card.innerHTML = `
                        <div class="md:w-1/3 bg-gray-50 flex items-center justify-center p-4">
                            <img src="${car.img}" alt="${car.name}" class="w-full h-full object-contain">
                        </div>
                        <div class="p-6 md:w-2/3 flex flex-col justify-between">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-900">${car.name} (<span data-i18n="${car.transmission.toLowerCase()}">${transmissionText}</span>)</h3>
                                <p class="text-gray-500 mb-4">${car.desc}</p>
                                <div class="grid grid-cols-2 gap-2 text-sm text-gray-700 mb-4">
                                    <span class="flex items-center ltr:justify-start"><i data-lucide="${car.transmission === 'Automatic' ? 'car' : 'gauge'}" class="w-4 h-4 ltr:mr-2 text-primary-dark"></i> <span data-i18n="${car.transmission.toLowerCase()}">${transmissionText}</span></span>
                                    <span class="flex items-center ltr:justify-start"><i data-lucide="snowflake" class="w-4 h-4 ltr:mr-2 text-primary-dark"></i> A/C</span>
                                    <span class="flex items-center ltr:justify-start"><i data-lucide="users" class="w-4 h-4 ltr:mr-2 text-primary-dark"></i> <span data-i18n="${seatsKey}">${seatsText}</span></span>
                                    <span class="flex items-center ltr:justify-start"><i data-lucide="paint-bucket" class="w-4 h-4 ltr:mr-2 text-primary-dark"></i> ${car.color}</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center border-t pt-4">
                                <div class="flex flex-col">
                                    <span class="text-xl font-extrabold text-primary-dark">${carPriceString} <span data-i18n="car-day" class="text-base font-normal text-gray-500">/ day</span></span>
                                </div>
                                <button class="book-now-btn accent-blue text-white font-semibold py-2 px-6 rounded-lg hover:accent-blue-dark transition duration-300 shadow-md"
                                            data-car-name="${car.name} (${car.color}, ${transmissionText})" 
                                            data-car-price="${carPriceString}"
                                            data-i18n="btn-book-now">
                                    Book Now
                                </button>
                            </div>
                        </div>
                    `;
                    resultsContainer.appendChild(card);
                });

                // RE-QUERY buttons and RE-ATTACH listeners
                attachModalListeners();
                lucide.createIcons();
            }

            function updateCarCount(count) {
                const text = getTranslation('sort-count-text');
                carCountElement.textContent = `${count} ${text}`;
            }

            function getCheckedValues(checkboxes) {
                return Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.value);
            }

            function filterCars() {
                const maxPrice = parseInt(priceRange.value);
                const selectedTransmissions = getCheckedValues(transmissionFilters);
                const selectedTypes = getCheckedValues(typeFilters);
                
                let visibleCount = 0;
                
                // Must re-query carCards here as they are dynamic
                carCards = document.querySelectorAll('.car-card'); 

                carCards.forEach(card => {
                    const carPrice = parseInt(card.getAttribute('data-price')); // Always filter on base DH price
                    const carTransmission = card.getAttribute('data-transmission');
                    const carType = card.getAttribute('data-type');

                    const priceMatch = carPrice <= maxPrice;
                    const transmissionMatch = selectedTransmissions.length === 0 || selectedTransmissions.includes(carTransmission);
                    const typeMatch = selectedTypes.length === 0 || selectedTypes.includes(carType);

                    if (priceMatch && transmissionMatch && typeMatch) {
                        card.style.display = 'flex'; 
                        visibleCount++;
                    } else {
                        card.style.display = 'none'; 
                    }
                });

                updateCarCount(visibleCount);
            }

            function toggleSidebar() {
                const isSidebarOpen = filterSidebar.classList.toggle('open');
                document.body.classList.toggle('overflow-hidden');
                filterBackdrop.classList.toggle('hidden', !isSidebarOpen);
            }

            /**
             * === SMART MODAL FUNCTION ===
             * Checks localStorage and uses the correct message template.
             */
            function openModal(carName, carPriceWithSymbol) {
                const dict = translations[currentLang];
                let whatsappMessage, emailSubject, emailBody;
                
                // carPriceWithSymbol is already formatted (e.g., "€140" or "1400 DH")

                // Check if data exists from the search form
                if (rentalLocation && rentalPickupDate && rentalReturnDate) {
                    // --- SCENARIO 1: FULL MESSAGE ---
                    let pickupDisplay = new Date(rentalPickupDate).toLocaleDateString(currentLang, { dateStyle: 'medium' });
                    let returnDisplay = new Date(rentalReturnDate).toLocaleDateString(currentLang, { dateStyle: 'medium' });

                    whatsappMessage = dict['book-whatsapp-msg-full'](carName, carPriceWithSymbol, rentalLocation, pickupDisplay, returnDisplay);
                    emailSubject = dict['book-email-subj-full'](carName, rentalLocation);
                    emailBody = dict['book-email-body-full'](carName, carPriceWithSymbol, rentalLocation, pickupDisplay, returnDisplay);
                
                } else {
                    // --- SCENARIO 2: CONCISE MESSAGE ---
                    whatsappMessage = dict['book-whatsapp-msg-concise'](carName, carPriceWithSymbol);
                    emailSubject = dict['book-email-subj-concise'](carName);
                    emailBody = dict['book-email-body-concise'](carName, carPriceWithSymbol);
                }
            
                whatsappLink.href = `https://wa.me/212602020402?text=${encodeURIComponent(whatsappMessage)}`;
                emailLink.href = `mailto:blackiriscars@gmail.com?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
            
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                }, 10);
                document.body.classList.add('overflow-hidden');
            }

            function closeModal() {
                modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                }, 300); 
            }
            
            /**
             * Attaches listeners to dynamically created buttons
             */
            function attachModalListeners() {
                // Re-query for book buttons AFTER renderAllCars()
                bookButtons = document.querySelectorAll('.book-now-btn');
                
                bookButtons.forEach(button => {
                    // Remove old listener to prevent duplicates
                    button.replaceWith(button.cloneNode(true));
                });
                
                // Re-query again after cloning
                bookButtons = document.querySelectorAll('.book-now-btn');
                
                bookButtons.forEach(button => {
                    button.addEventListener('click', (event) => {
                        const carName = event.currentTarget.getAttribute('data-car-name');
                        const carPrice = event.currentTarget.getAttribute('data-car-price');
                        openModal(carName, carPrice);
                    });
                });
            }

            // --- 5. NEW: Seamless Mobile Menu Logic ---
            function openMobileMenu() {
                mobileMenu.classList.remove('opacity-0', '-translate-y-2');
                mobileMenu.style.pointerEvents = 'auto';
            }

            function closeMobileMenu() {
                mobileMenu.classList.add('opacity-0', '-translate-y-2');
                mobileMenu.style.pointerEvents = 'none';
            }

            mobileMenuButton.addEventListener('click', (e) => {
                e.stopPropagation(); // Stop this click from triggering the document listener
                const isOpen = mobileMenu.classList.contains('opacity-0');
                if (isOpen) {
                    openMobileMenu();
                } else {
                    closeMobileMenu();
                }
            });

            // Close when a link is clicked
            mobileMenu.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', closeMobileMenu);
            });
            
            // Close on scroll
            window.addEventListener('scroll', closeMobileMenu);

            // Close on click outside
            document.addEventListener('click', (event) => {
                if (mobileMenu.classList.contains('opacity-0')) {
                    return; // Menu is already closed
                }
                const isClickInsideMenu = mobileMenu.contains(event.target);
                const isClickOnButton = mobileMenuButton.contains(event.target);

                if (!isClickInsideMenu && !isClickOnButton) {
                    closeMobileMenu();
                }
            });


            // --- 6. Attach Static Event Listeners ---
            
            langSelectors.forEach(selector => {
                selector.addEventListener('change', (event) => {
                    setLanguage(event.target.value);
                    localStorage.setItem('languagePreference', event.target.value);
                    renderAllCars(); // Re-render list with new language
                    filterCars();    // Re-apply filter
                });
            });

            currencySelectors.forEach(selector => {
                selector.addEventListener('change', (event) => {
                    setCurrency(event.target.value);
                    localStorage.setItem('currencyPreference', event.target.value);
                });
            });

            // Filter sidebar listeners
            filterButton.addEventListener('click', (e) => {
                e.stopPropagation(); // Stop this from closing the menu if it's open
                toggleSidebar();
            });
            filterCloseButton.addEventListener('click', toggleSidebar);
            filterBackdrop.addEventListener('click', toggleSidebar);
            
            resultsContainer.addEventListener('click', () => {
                 if (filterSidebar.classList.contains('open') && window.innerWidth < 768) { 
                     toggleSidebar();
                 }
            });

            // Filter action listeners
            applyFiltersBtn.addEventListener('click', () => {
                filterCars(); 
                if (filterSidebar.classList.contains('open')) {
                     toggleSidebar(); 
                }
            });

            priceRange.addEventListener('input', (event) => {
                 const prefix = currentLang === 'ar' ? 'يصل إلى' : 'Up to';
                 priceValue.textContent = `${prefix} ${event.target.value} DH`;
            });

            // Modal close listeners
            closeModalBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // --- 7. Run Initial Page Setup ---
            lucide.createIcons();
            getLocalStorageData(); // Get data from index page
            
            const savedLang = localStorage.getItem('languagePreference') || 'en';
            const savedCurrency = localStorage.getItem('currencyPreference') || 'DH';
            
            languageSelector.value = savedLang;
            currencySelector.value = savedCurrency;
            currentLang = savedLang;
            currentCurrency = savedCurrency;
            
            renderAllCars(); // Build the car list
            setLanguage(savedLang); // Set all text
            filterCars(); // Apply initial filter
        });
    </script>
</body>
</html>
